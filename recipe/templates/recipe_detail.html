<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ recipe.name }} - Recipe Detail</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detail.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
<header>
    {% include 'header.html' %}
</header>

<div class="breadcrumb">
    <a href="{{ url_for('home_bp.home') }}">Home < </a>
    <a href="{{ url_for('browse_bp.browse') }}">Browse < </a>
    <a href="{{ url_for('search_bp.search', filter_by=filter_by) }}">{{ recipe.category.name }} < </a>
    <a href="{{ url_for('recipe_bp.recipe_detail', recipe_id = recipe.id) }}">{{ recipe.name }}</a>
</div>

<div class="recipe-detail">
    <!-- Recipe Title -->
    <h1 class="recipe-title">{{ recipe.name }}</h1>

    <!-- Author & Date -->
    <div class="meta">
        <span>By {{ recipe.author.name }}</span> •
        <span>
            {{ recipe.created_date.utctime('%B %d, %Y') if recipe.created_date else "" }}
        </span>
    </div>

    <!-- Image -->
    <div class="recipe-image">
        <img src="{{ recipe.images[0] if recipe.images else 'https://via.placeholder.com/600x400?text=No+Image' }}"
             alt="{{ recipe.name }}">
    </div>

    <!-- Description -->
    <p class="recipe-description">{{ recipe.description }}</p>

    <!-- Times -->
    <div class="times">
        <p><strong>Cook time:</strong> {{ recipe.cook_time }} mins</p>
        <p><strong>Prep time:</strong> {{ recipe.preparation_time }} mins</p>
    </div>

    <!-- Category -->
    <p><strong>Category:</strong> {{ recipe.category.name if recipe.category else "Uncategorized" }}</p>

    <!-- Servings & Yield -->
    <p><strong>Servings:</strong> {{ recipe.servings or "-" }}</p>
    <p><strong>Yield:</strong> {{ recipe.recipe_yield or "-" }}</p>

    <!-- Rating -->
    <p><strong>Average Rating:</strong>
        {% if recipe.rating %}
            {% set full_stars = recipe.rating|int %}
            {% set half_star = 1 if (recipe.rating - full_stars) >= 0.5 else 0 %}
            {{ '★' * full_stars }}{{ '⯨' * half_star }} ({{ recipe.rating }})
        {% else %}
            Health star rating unavailable
        {% endif %}
    </p>

    <!-- Nutrition -->
    {% if recipe.nutrition %}
    <div class="nutrition">
        <h3>Nutrition</h3>
        <ul>
            <li>Calories: {{ recipe.nutrition.calories }}</li>
            <li>Fat: {{ recipe.nutrition.fat }} g</li>
            <li>Saturated Fat: {{ recipe.nutrition.saturated_fat }} g</li>
            <li>Cholesterol: {{ recipe.nutrition.cholesterol }} mg</li>
            <li>Sodium: {{ recipe.nutrition.sodium }} mg</li>
            <li>Carbs: {{ recipe.nutrition.carbohydrates }} g</li>
        </ul>
    </div>
    {% endif %}

    <!-- Ingredients -->
    <div class="ingredients">
        <h3>Ingredients</h3>
        <ul>
            {% for ingredient in recipe.ingredients %}
                <li>{{ ingredient }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Instructions -->
    <div class="instructions">
        <h3>Instructions</h3>
        <ul>
            {% for step in recipe.instructions %}
                <li>{{ step }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Reviews -->
    <div class="reviews">
        <h3>Reviews</h3>
        {% if reviews %}
            <ul>
                {% for r in reviews %}
                    <li>
                        <strong>{{ r.username }}</strong>
                        ({{ r.rating }}/5):
                        {{ r.review }}
                        <br>
                        <small>{{ r.date.strftime('%Y-%m-%d %H:%M') }}</small>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No reviews yet. Be the first!</p>
        {% endif %}
    </div>


    <!-- Add Review Form -->
    {% if 'user_name' in session %}
    <div class="add-review">
        <h3>Add Your Review</h3>
        <form method="POST" action="{{ handler_url }}">
            {{ form.hidden_tag() }}
            {{ form.recipe_id }}
            <div>
                {{ form.review_text.label }}<br>
                {{ form.review_text(rows=3) }}
                {% for error in form.review_text.errors %}
                    <span class="error">{{ error }}</span>
                {% endfor %}
            </div>
            <div>
                {{ form.rating.label }}<br>
                {{ form.rating(min=1, max=5) }}
                {% for error in form.rating.errors %}
                    <span class="error">{{ error }}</span>
                {% endfor %}
            </div>
            <div>
                {{ form.submit() }}
            </div>
        </form>
    </div>
    {% else %}
    <p><a href="{{ url_for('authentication_bp.login') }}" class="login-link">Login</a> to post a review.</p>
    {% endif %}
</div>

<footer>
    {% include 'footer.html' %}
</footer>
</body>
</html>
